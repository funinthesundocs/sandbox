---
phase: 01-foundation-4-hours
plan: 04
type: execute
wave: 2
depends_on:
  - "01-01"
  - "01-02"
files_modified:
  - src/app/layout.tsx
  - src/app/(dashboard)/layout.tsx
  - src/app/(dashboard)/page.tsx
  - src/app/(dashboard)/projects/page.tsx
  - src/app/(dashboard)/queue/page.tsx
  - src/app/(dashboard)/analytics/page.tsx
  - src/app/(dashboard)/admin/page.tsx
  - src/app/(dashboard)/settings/page.tsx
  - src/components/layout/Sidebar.tsx
  - src/components/layout/Header.tsx
  - src/components/layout/ThemeProvider.tsx
  - src/app/api/remix-engine/spec.json/route.ts
autonomous: true
requirements:
  - R1.5
  - RM.7
  - RM.10

must_haves:
  truths:
    - "Dashboard shell renders with sidebar and header when config.mode === standalone"
    - "Sidebar collapses to 64px icon rail and expands to 240px on click"
    - "Sidebar collapse state persists in localStorage with key re-sidebar-collapsed"
    - "Nav items use lucide-react icons: FolderOpen (Projects), ListChecks (Queue), BarChart2 (Analytics)"
    - "Admin and Settings nav items only visible to admin role (hidden for viewer/editor)"
    - "Active nav item has distinct visual treatment using --re-accent-primary color"
    - "Collapsed sidebar shows icon-only with Tooltip revealing the label on hover"
    - "Module mode layout returns children unwrapped (no sidebar/header)"
    - "/api/remix-engine/spec.json returns valid JSON with module contract"
    - "All color values in components use CSS variables — no hardcoded hex"
  artifacts:
    - path: "src/app/layout.tsx"
      provides: "Root layout with RemixEngineProvider and ThemeProvider wrapping"
      contains: "RemixEngineProvider"
    - path: "src/components/layout/Sidebar.tsx"
      provides: "Collapsible sidebar with role-based nav, localStorage persistence"
      min_lines: 80
    - path: "src/components/layout/Header.tsx"
      provides: "Header with page title and user avatar dropdown (logout)"
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Dashboard shell — mode check, renders Sidebar+Header or bare children"
      contains: "config.mode"
    - path: "src/app/api/remix-engine/spec.json/route.ts"
      provides: "GET handler returning module contract JSON"
  key_links:
    - from: "src/app/layout.tsx"
      to: "src/lib/remix-engine/provider.tsx"
      via: "RemixEngineProvider wraps entire app"
      pattern: "RemixEngineProvider"
    - from: "src/app/(dashboard)/layout.tsx"
      to: "src/lib/remix-engine/config.ts"
      via: "getServerConfig() to check mode before rendering shell"
      pattern: "getServerConfig"
    - from: "src/components/layout/Sidebar.tsx"
      to: "src/lib/remix-engine/hooks.ts"
      via: "useRemixEngine() to get config.routePrefix for nav links"
      pattern: "useRemixEngine"
---

<objective>
Build the dashboard shell UI — root layout with RemixEngineProvider, collapsible sidebar with role-based navigation, header with user dropdown, page shells for all nav destinations, and the spec.json API route. This is the visual foundation users see on every page.

Purpose: Without this, there is no UI to test auth against or to navigate through. The sidebar's collapse pattern and role-based nav are locked decisions from CONTEXT.md.
Output: Complete dashboard shell, all page placeholders, spec.json route.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-foundation-4-hours/01-CONTEXT.md
@.planning/phases/01-foundation-4-hours/01-RESEARCH.md

LOCKED DECISIONS (from CONTEXT.md — implement EXACTLY):
- Sidebar: collapsible — icon rail (64px) collapsed, 240px expanded, CLICK to toggle
- State persists in localStorage key: 're-sidebar-collapsed'
- Main nav: Projects (top), Queue, Analytics
- Bottom section: Admin, Settings — separated by divider
- Logo at top: icon-only when collapsed, with text when expanded
- Collapsed: icons only with hover Tooltip showing label
- Active state: distinct visual treatment (use --re-accent-primary)
- Header: page title (left) + user avatar dropdown (right)
- Avatar dropdown: profile info + logout
- Module boundary: Sidebar/Header ONLY render when config.mode === 'standalone'
- All nav links use config.routePrefix (not hardcoded paths)

CLAUDE'S DISCRETION (make reasonable choices):
- Icon selection from lucide-react for each nav item
- Active state styling details
- Transition animation for sidebar expand/collapse
- Avatar dropdown styling

CRITICAL: No hardcoded hex colors — all colors via --re-* CSS variables from design-system/MASTER.md.
React 19: no forwardRef.

<interfaces>
<!-- From Plan 01 (01-01) — use these in components -->
import { useRemixEngine } from '@/lib/remix-engine/hooks';
// useRemixEngine() returns RemixEngineConfig
// config.routePrefix = '/remix-engine' (for API routes)
// Use '/dashboard' for UI nav routes in standalone mode (CONTEXT.md decision)

import { getServerConfig } from '@/lib/remix-engine/config';
// Server-side config access

<!-- From Plan 02 (01-02) — CSS variables available in globals.css -->
// --re-bg-sidebar: sidebar background
// --re-bg-hover: hover state background
// --re-accent-primary: active item highlight
// --re-text-primary: primary text
// --re-text-muted: muted/secondary text
// --re-border: divider lines
// --re-sidebar-width: 240px
// --re-sidebar-width-collapsed: 64px
// --re-header-height: 56px
// --re-transition-base: 200ms ease

<!-- shadcn/ui components available (installed in Plan 02) -->
// DropdownMenu, Tooltip, Avatar, Separator, Button from @/components/ui/
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Root layout, ThemeProvider, and dashboard shell layout</name>
  <files>
    src/app/layout.tsx
    src/components/layout/ThemeProvider.tsx
    src/app/(dashboard)/layout.tsx
    src/app/(dashboard)/page.tsx
  </files>
  <action>
**src/components/layout/ThemeProvider.tsx** — 'use client'. Wrap next-themes ThemeProvider. Install next-themes first: npm install next-themes. Export ThemeProvider component that wraps children in NextThemesProvider with attribute="class" defaultTheme="dark" enableSystem={false}. This sets .dark class on html element, which activates the @custom-variant dark rules in globals.css.

**src/app/layout.tsx** — Root layout. Import ThemeProvider from '@/components/layout/ThemeProvider'. Import RemixEngineProvider from '@/lib/remix-engine/provider'. Wrap html > body in both providers: RemixEngineProvider (outer) and ThemeProvider (inner). Set lang="en" on html element. Keep existing font imports if present, otherwise remove the Geist font setup from the scaffolded file (not needed). Apply body class="bg-[--re-bg-primary] text-[--re-text-primary]". The layout must be: html > body > RemixEngineProvider > ThemeProvider > {children}.

Actually the correct nesting: RemixEngineProvider is a client component, but root layout should be a server component. Pattern: root layout (server) renders ThemeProvider (client) and RemixEngineProvider (client) as siblings or nested. Simplest: root layout exports default async function with html > body. Body children: a single Providers client component that wraps RemixEngineProvider + ThemeProvider, then {children}. Create src/app/providers.tsx as 'use client' that composes RemixEngineProvider and ThemeProvider around children.

**src/app/(dashboard)/layout.tsx** — Server component. Import getServerConfig from '@/lib/remix-engine/config'. Import Sidebar from '@/components/layout/Sidebar'. Import Header from '@/components/layout/Header'. Call config = getServerConfig(). If config.mode === 'module', return <>{children}</>. Otherwise render the full shell: a flex container, full screen height, background --re-bg-primary. Sidebar on left. Right side: flex column with Header at top (height --re-header-height), then main content area (flex-1, overflow-auto, padding 1.5rem). Exact structure per research Pattern 8.

**src/app/(dashboard)/page.tsx** — Simple redirect: import { redirect } from 'next/navigation'; export default function Page() { redirect('/dashboard/projects'); }

Note: Dashboard routes live at /dashboard/* (not /remix-engine/* — that's for API routes). The (dashboard) route group resolves to paths like /dashboard/projects, /dashboard/queue, etc.
  </action>
  <verify>
    <automated>cd /c/Antigravity/Sandbox && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>
    src/app/layout.tsx wraps app in RemixEngineProvider + ThemeProvider. src/app/(dashboard)/layout.tsx checks config.mode and conditionally renders shell. npx tsc --noEmit passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Sidebar, Header, page shells, and spec.json route</name>
  <files>
    src/components/layout/Sidebar.tsx
    src/components/layout/Header.tsx
    src/app/(dashboard)/projects/page.tsx
    src/app/(dashboard)/queue/page.tsx
    src/app/(dashboard)/analytics/page.tsx
    src/app/(dashboard)/admin/page.tsx
    src/app/(dashboard)/settings/page.tsx
    src/app/api/remix-engine/spec.json/route.ts
  </files>
  <action>
**src/components/layout/Sidebar.tsx** — 'use client'. Full implementation per locked decisions:

Imports: useState, useEffect from 'react'. usePathname from 'next/navigation'. Link from 'next/link'. useRemixEngine from '@/lib/remix-engine/hooks'. lucide-react icons: FolderOpen, ListChecks, BarChart2, ShieldCheck, Settings, ChevronLeft, ChevronRight (or PanelLeftClose/PanelLeftOpen), Zap (logo icon). Tooltip, TooltipContent, TooltipProvider, TooltipTrigger from '@/components/ui/tooltip'. Separator from '@/components/ui/separator'.

State: const [collapsed, setCollapsed] = useState(false). useEffect to read localStorage on mount: setCollapsed(localStorage.getItem('re-sidebar-collapsed') === 'true'). Toggle function: set state + write to localStorage.

Nav items array:
mainNav = [
  { label: 'Projects', href: '/dashboard/projects', icon: FolderOpen },
  { label: 'Queue', href: '/dashboard/queue', icon: ListChecks },
  { label: 'Analytics', href: '/dashboard/analytics', icon: BarChart2 },
]
bottomNav = [
  { label: 'Admin', href: '/dashboard/admin', icon: ShieldCheck, adminOnly: true },
  { label: 'Settings', href: '/dashboard/settings', icon: Settings },
]

Get role from useRemixEngine() if config.auth exists, else show all items (standalone mode with auth handled by middleware). Actually in standalone mode, role comes from the Supabase session — for Phase 1 shell, pass role as a prop or derive from a simple hook. Simplest: accept optional userRole prop. For now, render Admin item only if userRole === 'admin'. If userRole not provided, show all items (we'll connect real role in auth plan).

Sidebar structure:
- aside with style={{ width: collapsed ? 'var(--re-sidebar-width-collapsed)' : 'var(--re-sidebar-width)' }} and transition-all duration-200
- background: bg-[--re-bg-sidebar] border-r border-[--re-border] h-screen flex flex-col
- Top: logo area with Zap icon (always visible) + "RemixEngine" text (hidden when collapsed)
- Below logo: toggle button with ChevronLeft/ChevronRight icon
- Nav list: flex-1 overflow-y-auto py-4 px-2
- Each nav item: when collapsed, icon only wrapped in TooltipProvider showing label on hover
- When expanded: icon + label text side by side
- Active item: check usePathname() === item.href, apply bg-[--re-bg-hover] text-[--re-accent-primary] styling. Inactive: text-[--re-text-muted] hover:bg-[--re-bg-hover] hover:text-[--re-text-primary]
- Bottom: Separator, then bottomNav items (same pattern), pb-4

**src/components/layout/Header.tsx** — 'use client'. Import usePathname from 'next/navigation'. Import DropdownMenu components from '@/components/ui/dropdown-menu'. Import Avatar, AvatarFallback from '@/components/ui/avatar'. Import useRemixEngine from '@/lib/remix-engine/hooks'. Accept optional user prop { email?: string; name?: string }.

Header structure:
- header: height var(--re-header-height), flex items-center justify-between px-6, bg-[--re-bg-primary] border-b border-[--re-border]
- Left: page title — derive from pathname (e.g., '/dashboard/projects' → 'Projects')
- Right: DropdownMenu trigger is Avatar with AvatarFallback showing initials. DropdownMenuContent: profile info (email), separator, DropdownMenuItem for "Sign out" with a server action call (stub for now — wire in Plan 05)

For Phase 1, user prop can be optional. If no user, show default avatar. Wire real user data in auth plan.

**Page shells** — Create simple placeholder pages:

src/app/(dashboard)/projects/page.tsx: export default function ProjectsPage() { return <div className="text-[--re-text-primary]"><h1 className="text-2xl font-semibold">Projects</h1><p className="text-[--re-text-muted] mt-2">Coming in Phase 2.</p></div> }

Same pattern for queue/page.tsx (Queue), analytics/page.tsx (Analytics), admin/page.tsx (Admin), settings/page.tsx (Settings). Each with appropriate heading.

**src/app/api/remix-engine/spec.json/route.ts** — Create directory path src/app/api/remix-engine/spec.json/. Export GET handler that returns NextResponse.json() with the module contract object:
{
  name: 'RemixEngine',
  version: '1.0.0',
  mode: getServerConfig().mode,
  routePrefix: getServerConfig().routePrefix,
  tables: ['re_users','re_projects','re_videos','re_jobs','re_scenes','re_api_usage'],
  storagePrefix: getServerConfig().storagePrefix,
  queues: ['scrape','remix','generate','render'],
  routes: {
    health: '/api/remix-engine/health',
    spec: '/api/remix-engine/spec.json',
    scrape: '/api/remix-engine/scrape',
    remix: '/api/remix-engine/remix',
    generate: '/api/remix-engine/generate',
    render: '/api/remix-engine/render',
  }
}

Import getServerConfig from '@/lib/remix-engine/config'. Import { NextResponse } from 'next/server'. Export async function GET() returning NextResponse.json(specObject).
  </action>
  <verify>
    <automated>cd /c/Antigravity/Sandbox && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    Sidebar.tsx implements collapsed/expanded toggle with localStorage persistence. Mode check in dashboard layout. All page shells exist. spec.json route returns JSON. npx tsc --noEmit passes. No hardcoded hex colors in any component.
  </done>
</task>

</tasks>

<verification>
Run: npx tsc --noEmit — must pass with zero errors.
Check: grep -r "#[0-9a-fA-F]\{6\}" src/components/ returns empty (no hex colors).
Check: src/app/(dashboard)/layout.tsx contains "config.mode" check.
Check: src/components/layout/Sidebar.tsx contains "localStorage" and "re-sidebar-collapsed".
Check: src/app/api/remix-engine/spec.json/route.ts exports GET function.
</verification>

<success_criteria>
- Dashboard shell renders Sidebar + Header when config.mode === 'standalone'
- Module mode returns bare children — no shell UI
- Sidebar collapses to icon rail (64px) and expands to full width (240px) on click toggle
- Collapsed state persists in localStorage key 're-sidebar-collapsed'
- Nav items filtered by role (Admin hidden from non-admins)
- All five page shells render their placeholder content
- /api/remix-engine/spec.json route exists and returns JSON
- Zero hardcoded colors — all via --re-* CSS variables
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-4-hours/01-04-SUMMARY.md` following the summary template.
</output>
