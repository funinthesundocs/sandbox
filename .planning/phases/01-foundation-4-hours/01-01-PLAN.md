---
phase: 01-foundation-4-hours
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/remix-engine/config.ts
  - src/lib/remix-engine/provider.tsx
  - src/lib/remix-engine/hooks.ts
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/supabase/admin.ts
  - src/lib/queue/connection.ts
  - src/lib/queue/queues.ts
  - src/lib/validators/schemas.ts
  - src/worker/index.ts
  - tsconfig.worker.json
  - .env.example
  - .gitignore
autonomous: true
requirements:
  - R1.6
  - R1.7
  - R1.8
  - R1.10
  - RM.1
  - RM.2
  - RM.3
  - RM.4
  - RM.5
  - RM.9

must_haves:
  truths:
    - "RemixEngineConfig type is defined and exportable with all required fields"
    - "createStandaloneConfig() is the only place process.env is read — all other files use getServerConfig() or useRemixEngine()"
    - "Supabase browser and server clients read from config, not process.env"
    - "BullMQ queues (scrape, remix, generate, render) are defined and importable"
    - "Worker TypeScript compiles with tsconfig.worker.json using relative imports only"
    - "Zod validation schemas file exists with core schemas"
    - ".env.example documents all required environment variables"
  artifacts:
    - path: "src/lib/remix-engine/config.ts"
      provides: "RemixEngineConfig type, createStandaloneConfig(), getServerConfig(), setServerConfig()"
      exports: ["RemixEngineConfig", "createStandaloneConfig", "getServerConfig", "setServerConfig"]
    - path: "src/lib/remix-engine/provider.tsx"
      provides: "RemixEngineProvider React context component"
      exports: ["RemixEngineProvider"]
    - path: "src/lib/remix-engine/hooks.ts"
      provides: "useRemixEngine hook, table() and storagePath() helpers, RemixEngineContext"
      exports: ["useRemixEngine", "table", "storagePath", "RemixEngineContext"]
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client using config, not process.env"
    - path: "src/lib/supabase/server.ts"
      provides: "Server Supabase client using config, not process.env"
    - path: "src/lib/supabase/admin.ts"
      provides: "Service role client for worker use"
    - path: "src/lib/queue/connection.ts"
      provides: "IORedis connection instance with maxRetriesPerRequest: null"
    - path: "src/lib/queue/queues.ts"
      provides: "BullMQ Queue instances: scrapeQueue, remixQueue, generateQueue, renderQueue"
    - path: "src/lib/validators/schemas.ts"
      provides: "Zod schemas for Phase 1 data (InviteUser, Project, etc.)"
    - path: "tsconfig.worker.json"
      provides: "Worker TypeScript config — no @/ aliases, CommonJS output"
  key_links:
    - from: "src/lib/remix-engine/provider.tsx"
      to: "src/lib/remix-engine/config.ts"
      via: "createStandaloneConfig() call in standalone mode branch"
      pattern: "createStandaloneConfig"
    - from: "src/lib/supabase/client.ts"
      to: "src/lib/remix-engine/config.ts"
      via: "import getServerConfig — not process.env"
      pattern: "getServerConfig"
    - from: "src/lib/queue/connection.ts"
      to: "src/lib/remix-engine/config.ts"
      via: "getServerConfig().redis.url"
      pattern: "getServerConfig\\(\\)\\.redis"
---

<objective>
Establish the RemixEngine module boundary — the foundational infrastructure that every other piece of code depends on. This plan creates the config system, React context, corrected Supabase clients, BullMQ queue definitions, worker TypeScript config, Zod schemas, and environment documentation.

Purpose: Without this, nothing else can be built correctly. The config/provider/hooks triad is the architectural spine. The existing Supabase clients read process.env directly and must be replaced.
Output: Complete infrastructure layer — RemixEngineProvider, corrected Supabase clients, BullMQ queues, worker build config, Zod schemas, env docs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-foundation-4-hours/01-RESEARCH.md

CRITICAL RULES (from CLAUDE.md — non-negotiable):
- Business logic NEVER reads process.env — only createStandaloneConfig() in config.ts does
- All DB tables use table() helper (never bare 're_videos')
- All storage paths use storagePath() helper
- Worker uses tsconfig.worker.json — relative imports only, no @/ aliases
- BullMQ requires maxRetriesPerRequest: null on IORedis connection
- React 19: no forwardRef — pass ref as regular prop
- Tailwind v4: no tailwind.config.js — CSS-first configuration

SPEC REFERENCES: Read REMIXENGINE_SPEC_v3.md Section 0 for the exact RemixEngineConfig interface and provider pattern. Section 6 for Zod schemas. Section 4 for BullMQ queue names.

<interfaces>
<!-- The exact RemixEngineConfig interface to implement — do not deviate from this shape -->
interface RemixEngineConfig {
  mode: 'standalone' | 'module';
  routePrefix: string;           // default: '/remix-engine' (for API routes)
  supabase: {
    url: string;
    anonKey: string;
    serviceRoleKey: string;
  };
  redis: { url: string };
  apiKeys: {
    youtube: string;
    gemini: string;
    falAi: string;
    elevenLabs: string;
    heyGen: string;
    runwayMl: string;
    kling?: string;
  };
  auth?: {
    user: { id: string; email: string; full_name?: string };
    role: 'admin' | 'editor' | 'viewer';
  };
  webhookBaseUrl: string;
  storagePrefix: string;   // default: 'remix-engine'
  tablePrefix: string;     // default: 're_'
}

<!-- Existing files that must be REPLACED (they read process.env directly — violation) -->
<!-- src/lib/supabase/client.ts — currently uses process.env.NEXT_PUBLIC_SUPABASE_URL -->
<!-- src/lib/supabase/server.ts — currently uses process.env.NEXT_PUBLIC_SUPABASE_URL -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: RemixEngine config, provider, and hooks</name>
  <files>
    src/lib/remix-engine/config.ts
    src/lib/remix-engine/provider.tsx
    src/lib/remix-engine/hooks.ts
  </files>
  <action>
Create the three core files that form the RemixEngine module boundary.

**src/lib/remix-engine/config.ts** — Export the RemixEngineConfig interface (exact shape above), createStandaloneConfig() which reads process.env ONLY HERE, a server singleton via getServerConfig() and setServerConfig(). createStandaloneConfig() maps: NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY, REDIS_URL, YOUTUBE_DATA_API_KEY, GOOGLE_GEMINI_API_KEY, FAL_KEY, ELEVENLABS_API_KEY, HEYGEN_API_KEY, RUNWAY_API_KEY, KLING_API_KEY (optional), WEBHOOK_BASE_URL || NEXT_PUBLIC_APP_URL, storagePrefix='remix-engine', tablePrefix='re_'.

**src/lib/remix-engine/provider.tsx** — 'use client'. Creates RemixEngineContext (null default) and exports RemixEngineProvider. In standalone mode it calls createStandaloneConfig() and passes result as context value. Accept children prop (React.ReactNode). Also accept optional config prop to support module mode injection. If config prop provided, use it; otherwise call createStandaloneConfig().

**src/lib/remix-engine/hooks.ts** — Export RemixEngineContext (exported so provider.tsx can import it), useRemixEngine() hook that throws if used outside provider. Export two SERVER-SIDE helpers (not hooks — they call getServerConfig() directly): table(name: string): string returns `${getServerConfig().tablePrefix}${name}`, storagePath(...segments: string[]): string returns `[getServerConfig().storagePrefix, ...segments].join('/')`.

Do NOT use forwardRef anywhere — React 19. Do NOT read process.env in provider.tsx or hooks.ts.
  </action>
  <verify>
    <automated>cd /c/Antigravity/Sandbox && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    TypeScript compiles cleanly. RemixEngineConfig interface exported from config.ts. createStandaloneConfig() is the ONLY function reading process.env. getServerConfig() returns singleton. useRemixEngine() throws if called outside context. table('videos') returns 're_videos'. storagePath('videos','a','b') returns 'remix-engine/videos/a/b'.
  </done>
</task>

<task type="auto">
  <name>Task 2: Supabase clients, queue, worker scaffold, env docs, Zod schemas</name>
  <files>
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    src/lib/supabase/admin.ts
    src/lib/queue/connection.ts
    src/lib/queue/queues.ts
    src/lib/validators/schemas.ts
    src/worker/index.ts
    tsconfig.worker.json
    .env.example
    .gitignore
  </files>
  <action>
**src/lib/supabase/client.ts** — REPLACE existing file entirely. Import createBrowserClient from @supabase/ssr. Import getServerConfig from '../remix-engine/config'. Export createClient() that reads config via getServerConfig() for supabase.url and supabase.anonKey. NO process.env here.

**src/lib/supabase/server.ts** — REPLACE existing file entirely. Import createServerClient from @supabase/ssr. Import cookies from 'next/headers'. Import getServerConfig from '../remix-engine/config'. Export async createClient() using getServerConfig() for url and anonKey. Keep cookie getAll/setAll pattern (setAll has try/catch for Server Component safety). NO process.env here.

**src/lib/supabase/admin.ts** — NEW file. Import createClient from @supabase/supabase-js. Import getServerConfig from '../remix-engine/config'. Create and export supabaseAdmin = createClient(config.supabase.url, config.supabase.serviceRoleKey, { auth: { persistSession: false } }). Comment: "For worker use only — bypasses RLS".

**src/lib/queue/connection.ts** — NEW file. Import IORedis from 'ioredis'. Import getServerConfig from '../remix-engine/config'. Export redisConnection = new IORedis(getServerConfig().redis.url, { maxRetriesPerRequest: null }). The maxRetriesPerRequest: null is REQUIRED by BullMQ — do not omit.

**src/lib/queue/queues.ts** — NEW file. Import Queue from 'bullmq'. Import redisConnection from './connection'. Export four queues: scrapeQueue = new Queue('scrape', { connection: redisConnection }), remixQueue = new Queue('remix', ...), generateQueue = new Queue('generate', ...), renderQueue = new Queue('render', ...).

**src/lib/validators/schemas.ts** — NEW file. Define and export Zod schemas using z.object():
- InviteUserSchema: { email: z.string().email(), role: z.enum(['admin','editor','viewer']).default('editor'), fullName: z.string().optional() }
- ProjectSchema: { name: z.string().min(1).max(100), description: z.string().optional() }
- VideoUrlSchema: { url: z.string().url().refine(u => u.includes('youtube.com') || u.includes('youtu.be'), 'Must be a YouTube URL') }
Read REMIXENGINE_SPEC_v3.md Section 6 for additional schemas and add them all.

**src/worker/index.ts** — NEW stub file. Use relative imports only (not @/ aliases). Comment block at top: "Worker entry point — runs as separate Node.js process outside Next.js. Uses tsconfig.worker.json. No @/ aliases. Import from relative paths only." Export placeholder async main() that logs "RemixEngine worker starting..." and sets up graceful shutdown on SIGTERM/SIGINT.

**tsconfig.worker.json** — NEW file at repo root. Exact content:
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "moduleResolution": "node",
    "esModuleInterop": true,
    "strict": true,
    "skipLibCheck": true,
    "outDir": "./dist/worker",
    "rootDir": "./src"
  },
  "include": ["src/worker/**/*", "src/lib/**/*"],
  "exclude": ["node_modules", ".next"]
}

**.env.example** — Document ALL required env vars with comments explaining each:
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...
# App
NEXT_PUBLIC_APP_URL=http://localhost:3000
WEBHOOK_BASE_URL=http://localhost:3000
# Redis
REDIS_URL=redis://localhost:6379
# External APIs
YOUTUBE_DATA_API_KEY=
GOOGLE_GEMINI_API_KEY=
FAL_KEY=
ELEVENLABS_API_KEY=
HEYGEN_API_KEY=
RUNWAY_API_KEY=
KLING_API_KEY= (optional)

**.gitignore** — Add these lines if not already present (check first, do not duplicate):
.env.local
/tmp/remixengine/
supabase/.temp/
dist/

Install required packages: npm install bullmq ioredis zod
  </action>
  <verify>
    <automated>cd /c/Antigravity/Sandbox && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    npx tsc --noEmit passes with zero errors. No file imports process.env except src/lib/remix-engine/config.ts. scrapeQueue, remixQueue, generateQueue, renderQueue exported from queues.ts. tsconfig.worker.json exists at repo root. .env.example documents all env vars. bullmq and ioredis and zod in package.json.
  </done>
</task>

</tasks>

<verification>
Run: npx tsc --noEmit — must pass with zero errors.
Run: grep -r "process\.env" src/ --include="*.ts" --include="*.tsx" | grep -v "src/lib/remix-engine/config.ts" — must return empty (no violations).
Check: src/lib/supabase/client.ts must NOT contain process.env.
Check: src/lib/queue/connection.ts must contain maxRetriesPerRequest: null.
Check: tsconfig.worker.json exists with no @/ paths configured.
</verification>

<success_criteria>
- RemixEngineConfig interface exported and matches the exact shape from REQUIREMENTS.md RM.2
- process.env appears in exactly ONE file: src/lib/remix-engine/config.ts
- Four BullMQ queues defined and importable
- tsconfig.worker.json compiles worker with relative imports
- Zod schemas defined for core data types
- .env.example documents all required secrets
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-4-hours/01-01-SUMMARY.md` following the summary template.
</output>
