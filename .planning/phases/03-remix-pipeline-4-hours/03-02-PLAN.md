---
phase: 03-remix-pipeline-4-hours
plan: 02
type: execute
wave: 1
depends_on:
  - "03-00"
files_modified:
  - src/lib/remix/thumbnail-types.ts
  - src/lib/remix/thumbnail-prompts.ts
  - src/lib/remix/thumbnail-analyzer.ts
  - src/lib/remix/thumbnail-remixer.ts
autonomous: true
requirements:
  - R3.2

must_haves:
  truths:
    - "analyzeThumbnail() fetches the image URL, converts to base64, and returns a structured text description from Gemini Vision"
    - "analyzeThumbnail() gracefully degrades (returns generic fallback text) if the image fetch fails — it never throws on network error"
    - "generateThumbnailVariation() calls fal.ai FLUX via subscribe() and returns the generated image URL at 1280x720"
    - "Both functions use getServerConfig() for API keys — zero process.env"
  artifacts:
    - path: "src/lib/remix/thumbnail-types.ts"
      provides: "ThumbnailGenerationParams, ThumbnailAnalysisResult Zod schemas"
      exports: ["ThumbnailGenerationParams", "ThumbnailAnalysisResult"]
    - path: "src/lib/remix/thumbnail-analyzer.ts"
      provides: "analyzeThumbnail function (Gemini Vision)"
      exports: ["analyzeThumbnail"]
    - path: "src/lib/remix/thumbnail-remixer.ts"
      provides: "generateThumbnailVariation function (fal.ai FLUX)"
      exports: ["generateThumbnailVariation"]
  key_links:
    - from: "src/lib/remix/thumbnail-analyzer.ts"
      to: "src/lib/remix-engine/config.ts"
      via: "getServerConfig().apiKeys.gemini"
      pattern: "getServerConfig"
    - from: "src/lib/remix/thumbnail-remixer.ts"
      to: "src/lib/remix-engine/config.ts"
      via: "getServerConfig().apiKeys.falAi"
      pattern: "getServerConfig"
---

<objective>
Implement the thumbnail remix library: Gemini Vision analysis of the original thumbnail and fal.ai FLUX image generation for 3 new thumbnail variations at 1280x720.

Purpose: Provides the AI-driven thumbnail generation pipeline. Runs in Wave 1 parallel to Plan 01 because all files are independent.

Output: `src/lib/remix/thumbnail-*.ts` files ready for import by the worker handler (Plan 03).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md

Key constraints:
- Plan 01 installs `@google/generative-ai` and `@fal-ai/serverless-client`. If Plan 01 runs first, packages are available. If Plans 01+02 run in parallel, run `npm install` here too (idempotent).
- fal.ai subscribe() timeout: set to 300000ms (5 min) — default 60s causes failures per RESEARCH.md Pitfall 2
- Thumbnail must be stored in Supabase Storage (NOT use the fal.ai URL directly as permanent storage — fal.ai URLs expire). The worker handler (Plan 03) is responsible for downloading and uploading to storage. This library just returns the temporary fal.ai URL.
- Graceful degradation: analyzeThumbnail catching network errors and returning fallback is non-negotiable

<interfaces>
<!-- Key types the executor needs -->

From src/lib/remix-engine/config.ts:
```typescript
interface RemixEngineConfig {
  apiKeys: {
    gemini: string;
    falAi: string;
  };
}
export function getServerConfig(): RemixEngineConfig;
```

From src/lib/supabase/types.ts (re_remixed_thumbnails schema reference):
```typescript
// re_remixed_thumbnails
{ id, video_id, prompt, analysis, file_path, is_selected, created_at }
// Note: file_path is the Supabase Storage path (not fal.ai URL)
// The worker handler downloads the fal.ai URL and uploads to storage
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create thumbnail types and Gemini Vision analyzer</name>
  <files>
    src/lib/remix/thumbnail-types.ts
    src/lib/remix/thumbnail-prompts.ts
    src/lib/remix/thumbnail-analyzer.ts
  </files>
  <action>
**Step 1: Create `src/lib/remix/thumbnail-types.ts`**

Types for thumbnail generation. The 3 variation styles define how prompts are crafted:

```typescript
import { z } from 'zod';

// The 3 thumbnail variation styles — each gets a different visual approach
export const ThumbnailStyleSchema = z.enum([
  'bold-text-overlay',   // High contrast text, minimal imagery
  'cinematic-scene',     // Atmospheric, wide shot, mood-driven
  'face-reaction',       // Close-up expressive face/character
]);

export const ThumbnailGenerationParamsSchema = z.object({
  videoId: z.string().uuid(),
  originalThumbnailUrl: z.string().url().optional(),
  videoTitle: z.string(),
  videoDescription: z.string(),
  style: ThumbnailStyleSchema,
  stylePromptOverride: z.string().optional(), // User's custom style prompt for regeneration
});

export const ThumbnailAnalysisResultSchema = z.object({
  description: z.string(),
  colors: z.string(),
  composition: z.string(),
  mood: z.string(),
});

export type ThumbnailStyle = z.infer<typeof ThumbnailStyleSchema>;
export type ThumbnailGenerationParams = z.infer<typeof ThumbnailGenerationParamsSchema>;
export type ThumbnailAnalysisResult = z.infer<typeof ThumbnailAnalysisResultSchema>;
```

**Step 2: Create `src/lib/remix/thumbnail-prompts.ts`**

Build context-aware fal.ai prompts for each of the 3 styles. When analysis is available, incorporate it. The prompt is a fal.ai image generation prompt — concise, visual, descriptive:

```typescript
import { ThumbnailStyle } from './thumbnail-types';

export function buildThumbnailPrompt(params: {
  videoTitle: string;
  style: ThumbnailStyle;
  analysisContext?: string;
  stylePromptOverride?: string;
}): string {
  const baseContext = params.analysisContext
    ? `Based on this YouTube thumbnail analysis: ${params.analysisContext.substring(0, 300)}. `
    : '';

  const override = params.stylePromptOverride
    ? ` Style modifier: ${params.stylePromptOverride}.`
    : '';

  const titleShort = params.videoTitle.substring(0, 60);

  const stylePrompts: Record<ThumbnailStyle, string> = {
    'bold-text-overlay': `YouTube thumbnail, bold dramatic text overlay "${titleShort}", high contrast colors, professional graphic design, clean background, eye-catching typography, 16:9 aspect ratio, 4K quality${override}`,
    'cinematic-scene': `YouTube thumbnail, cinematic widescreen scene related to "${titleShort}", dramatic lighting, atmospheric mood, professional photography, vibrant colors, no text overlays, 16:9 aspect ratio${override}`,
    'face-reaction': `YouTube thumbnail, expressive person or character reaction related to "${titleShort}", close-up portrait, dramatic expression, bright colors, studio lighting, highly engaging, 16:9 aspect ratio${override}`,
  };

  return baseContext + stylePrompts[params.style];
}
```

**Step 3: Create `src/lib/remix/thumbnail-analyzer.ts`**

Gemini Vision analysis of the original thumbnail. This is NON-FATAL — if the original thumbnail URL is missing or the fetch fails, return a generic fallback string rather than throwing. The fal.ai prompt will still work without analysis context:

```typescript
import { GoogleGenerativeAI, Part } from '@google/generative-ai';
import { getServerConfig } from '../remix-engine/config';

export async function analyzeThumbnail(thumbnailUrl: string): Promise<string> {
  const config = getServerConfig();
  const genAI = new GoogleGenerativeAI(config.apiKeys.gemini);
  const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash' });

  // Fetch and convert to base64 — gracefully degrades on failure
  let imageData: string;
  try {
    const response = await fetch(thumbnailUrl, { signal: AbortSignal.timeout(10000) });
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const buffer = await response.arrayBuffer();
    imageData = Buffer.from(buffer).toString('base64');
  } catch {
    // Non-fatal: return generic analysis so thumbnail generation can still proceed
    return 'Unable to analyze original thumbnail. Using default composition for generation.';
  }

  const prompt = `Analyze this YouTube thumbnail briefly. In 2-3 sentences describe: dominant colors, main visual element, and overall mood. Be specific and visual. No bullet points.`;

  try {
    const result = await model.generateContent({
      contents: [
        {
          role: 'user',
          parts: [
            { text: prompt },
            { inlineData: { mimeType: 'image/jpeg', data: imageData } },
          ] as Part[],
        },
      ],
    });
    return result.response.text();
  } catch {
    return 'Thumbnail analysis unavailable. Using default composition for generation.';
  }
}
```
  </action>
  <verify>
    <automated>npx tsc --noEmit && npm run test -- src/lib/remix/__tests__/thumbnail-analyzer.test.ts --watchAll=false</automated>
  </verify>
  <done>
    - `src/lib/remix/thumbnail-types.ts` exports ThumbnailStyleSchema, ThumbnailGenerationParams, ThumbnailAnalysisResult
    - `src/lib/remix/thumbnail-prompts.ts` exports buildThumbnailPrompt with all 3 style variants
    - `src/lib/remix/thumbnail-analyzer.ts` exports analyzeThumbnail with graceful degradation on fetch failure
    - TypeScript compiles clean
    - `thumbnail-analyzer.test.ts` passes (all 4 tests GREEN, including graceful degradation cases)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create fal.ai thumbnail generation library</name>
  <files>
    src/lib/remix/thumbnail-remixer.ts
  </files>
  <action>
**Create `src/lib/remix/thumbnail-remixer.ts`**

Implements `generateThumbnailVariation()` using `fal.subscribe()`. Critical constraints:
- Set `timeout: 300000` (5 minutes) — default 60s causes failures
- Return the temporary fal.ai URL — storage upload is the worker handler's responsibility (Plan 03)
- Unique `seed` per call ensures visual variation across the 3 generated thumbnails
- `onQueueUpdate` callback is used to surface progress to the worker job progress reporter (passed in via params)

```typescript
import * as fal from '@fal-ai/serverless-client';
import { getServerConfig } from '../remix-engine/config';
import { ThumbnailGenerationParams } from './thumbnail-types';
import { buildThumbnailPrompt } from './thumbnail-prompts';
import { analyzeThumbnail } from './thumbnail-analyzer';

export interface GeneratedThumbnail {
  falUrl: string;   // Temporary fal.ai URL — download and upload to storage in worker
  prompt: string;   // The prompt used (stored in re_remixed_thumbnails.prompt)
  analysis: string; // Gemini Vision analysis (stored in re_remixed_thumbnails.analysis)
}

export async function generateThumbnailVariation(
  params: ThumbnailGenerationParams,
  onProgress?: (status: string) => void
): Promise<GeneratedThumbnail> {
  const config = getServerConfig();

  // Initialize fal client with API key from config (never process.env)
  fal.config({ credentials: config.apiKeys.falAi });

  // Step 1: Analyze original thumbnail (non-fatal)
  let analysis = 'No original thumbnail available.';
  if (params.originalThumbnailUrl) {
    analysis = await analyzeThumbnail(params.originalThumbnailUrl);
  }

  // Step 2: Build the image generation prompt
  const prompt = buildThumbnailPrompt({
    videoTitle: params.videoTitle,
    style: params.style,
    analysisContext: analysis,
    stylePromptOverride: params.stylePromptOverride,
  });

  // Step 3: Generate via fal.ai FLUX
  // Using unique seed per call for variation across the 3 thumbnails
  const result = await fal.subscribe('fal-ai/flux/dev', {
    input: {
      prompt,
      image_size: { width: 1280, height: 720 }, // YouTube thumbnail dimensions
      num_images: 1,
      enable_safety_checker: true,
      seed: Math.floor(Math.random() * 1_000_000),
    },
    onQueueUpdate: (update) => {
      onProgress?.(`fal.ai: ${update.status}`);
    },
    // 5-minute timeout — fal.ai default (60s) causes failures under load
    // @ts-expect-error timeout is supported but not in all type versions
    timeout: 300000,
  });

  const images = (result as { images?: Array<{ url: string }> }).images;
  if (!images || images.length === 0) {
    throw new Error('fal.ai returned no images for thumbnail generation');
  }

  return {
    falUrl: images[0].url,
    prompt,
    analysis,
  };
}
```

Note: The `@ts-expect-error` comment on the timeout option is acceptable if the fal.ai type definition doesn't include it — it IS supported at runtime. If the installed type version includes timeout, remove the comment.
  </action>
  <verify>
    <automated>npx tsc --noEmit && npm run test -- src/lib/remix/__tests__/thumbnail-remixer.test.ts --watchAll=false</automated>
  </verify>
  <done>
    - `src/lib/remix/thumbnail-remixer.ts` exports `generateThumbnailVariation` and `GeneratedThumbnail` type
    - Function calls `fal.subscribe('fal-ai/flux/dev', ...)` with 1280x720 image size
    - Uses `getServerConfig().apiKeys.falAi` — zero process.env
    - Returns `{ falUrl, prompt, analysis }` — worker is responsible for storage upload
    - TypeScript compiles clean
    - `thumbnail-remixer.test.ts` passes (all 5 tests GREEN, including 1280x720 dimension check)
  </done>
</task>

</tasks>

<verification>
```bash
npx tsc --noEmit
npm run lint
npm run test -- src/lib/remix/__tests__/thumbnail-analyzer.test.ts src/lib/remix/__tests__/thumbnail-remixer.test.ts --watchAll=false
```
All must pass with zero errors.
</verification>

<success_criteria>
- `src/lib/remix/thumbnail-types.ts`, `thumbnail-prompts.ts`, `thumbnail-analyzer.ts`, `thumbnail-remixer.ts` all exist
- `generateThumbnailVariation()` exported and TypeScript-clean
- `analyzeThumbnail()` gracefully degrades on network failure (no throw)
- fal.ai `subscribe()` called with `image_size: { width: 1280, height: 720 }`
- Zero TypeScript errors
- `thumbnail-analyzer.test.ts` and `thumbnail-remixer.test.ts` all tests GREEN
</success_criteria>

<output>
After completion, create `.planning/phases/03-remix-pipeline-4-hours/03-02-SUMMARY.md`
</output>
