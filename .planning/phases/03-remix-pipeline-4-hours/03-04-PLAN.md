---
phase: 03-remix-pipeline-4-hours
plan: 04
type: execute
wave: 3
depends_on:
  - "03-00"
  - "03-03"
files_modified:
  - src/app/(dashboard)/projects/[id]/videos/[videoId]/page.tsx
  - src/app/(dashboard)/projects/[id]/videos/[videoId]/remix/page.tsx
  - src/components/remix/PipelineTabs.tsx
  - src/components/remix/StartRemixButton.tsx
autonomous: true
requirements:
  - R3.4
  - R3.5
  - R3.6

must_haves:
  truths:
    - "Video detail page shows 3 pipeline tabs: Scraping, Remix Review, Generation"
    - "Start Remix button on video detail page triggers a POST to all 3 remix endpoints (title, thumbnail, script) and shows a loading state"
    - "Remix Review tab is active only when remix_status is 'complete'; Generation tab is locked with a lock icon until approval"
    - "Navigating to the remix tab shows the remix review page (server component fetches all remix data)"
    - "Remix review page renders title count, thumbnail count, and scene count to confirm data loaded"
  artifacts:
    - path: "src/components/remix/PipelineTabs.tsx"
      provides: "Pipeline tab navigation component with Scraping | Remix Review | Generation tabs"
      exports: ["PipelineTabs"]
    - path: "src/components/remix/StartRemixButton.tsx"
      provides: "Client button that calls title+thumbnail+script remix APIs and shows job progress"
      exports: ["StartRemixButton"]
    - path: "src/app/(dashboard)/projects/[id]/videos/[videoId]/remix/page.tsx"
      provides: "Remix review server page — fetches remix data from DB"
      exports: ["default"]
  key_links:
    - from: "src/app/(dashboard)/projects/[id]/videos/[videoId]/page.tsx"
      to: "src/components/remix/PipelineTabs.tsx"
      via: "import PipelineTabs"
      pattern: "PipelineTabs"
    - from: "src/components/remix/StartRemixButton.tsx"
      to: "/api/remix-engine/remix/title"
      via: "fetch POST"
      pattern: "fetch.*remix.*title"
---

<objective>
Wire the video detail page with pipeline tab navigation and an active Start Remix button, and create the remix review page shell that loads remix data from the database.

Purpose: Makes the remix pipeline accessible from the video detail page. User can trigger remix and navigate to the review page. The review page confirms remix data loaded before the full UI (Plan 05) is added.

Output: Pipeline tabs component, Start Remix button, remix review page shell.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@design-system/MASTER.md

Read the design system MASTER.md before building any UI. Use `--re-*` CSS variables. No hardcoded hex colors.

Key constraints from CONTEXT.md (locked decisions):
- Pipeline tab pattern: Scraping → Remix Review (active during this phase) → Generation (locked)
- Post-approve but pre-generation: user can revise selections
- Once generation begins, selections are locked

Key constraints from STATE.md:
- Dark mode always-on via .dark class on html
- CSS variables: `--re-bg-primary`, `--re-text-primary`, `--re-accent-primary`, etc.
- Sidebar uses hardcoded /dashboard/* paths (not routePrefix) for UI nav

<interfaces>
<!-- Key types the executor needs -->

From src/lib/supabase/types.ts:
```typescript
type ReVideo = {
  id: string;
  remix_status: 'pending' | 'processing' | 'complete' | 'error';
  generation_status: 'pending' | 'processing' | 'complete' | 'error';
  // ...
};

// re_remixed_titles: { id, video_id, style, title, reasoning, is_selected }
// re_remixed_thumbnails: { id, video_id, prompt, analysis, file_path, is_selected }
// re_remixed_scripts: { id, video_id, full_script, tone, total_duration_seconds, is_selected }
// re_scenes: { id, script_id, scene_number, dialogue_line, duration_seconds, broll_description }
```

From src/app/(dashboard)/projects/[id]/videos/[videoId]/page.tsx (existing, will be modified):
- Server component with params: `{ id: projectId, videoId }`
- Fetches video with: `supabase.from('re_videos').select('*').eq('id', videoId).eq('project_id', projectId).single()`
- Currently renders: back link, title+metadata row, VideoDetailLayout
- Currently has a disabled "Start Remix" Button that needs to be replaced with StartRemixButton

Start Remix button (currently disabled in page.tsx line 139):
```tsx
<Button variant="default" size="sm" disabled>
  <Wand2 className="w-4 h-4 mr-1" />
  Start Remix
</Button>
```
This must be replaced with the new `<StartRemixButton>` component.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PipelineTabs and StartRemixButton components</name>
  <files>
    src/components/remix/PipelineTabs.tsx
    src/components/remix/StartRemixButton.tsx
  </files>
  <action>
Read `design-system/MASTER.md` first to understand the token palette before writing any styles.

**Create `src/components/remix/PipelineTabs.tsx`** (server component — receives status as props)

Shows 3 pipeline stages. Active tab styling: accent color underline. Locked tab: muted with lock icon. Completed tab: checkmark icon. Uses `Link` for navigation:

```tsx
'use client';

import Link from 'next/link';
import { CheckCircle2, Lock, Loader2 } from 'lucide-react';

interface PipelineTabsProps {
  projectId: string;
  videoId: string;
  scrapeStatus: 'pending' | 'processing' | 'complete' | 'error';
  remixStatus: 'pending' | 'processing' | 'complete' | 'error';
  generationStatus: 'pending' | 'processing' | 'complete' | 'error';
  activeTab: 'scraping' | 'remix' | 'generation';
}

export function PipelineTabs({
  projectId, videoId, scrapeStatus, remixStatus, generationStatus, activeTab,
}: PipelineTabsProps) {
  const baseVideoPath = `/dashboard/projects/${projectId}/videos/${videoId}`;

  const tabs = [
    {
      id: 'scraping' as const,
      label: 'Scraping',
      href: baseVideoPath,
      status: scrapeStatus,
      locked: false,
    },
    {
      id: 'remix' as const,
      label: 'Remix Review',
      href: `${baseVideoPath}/remix`,
      status: remixStatus,
      locked: scrapeStatus !== 'complete',
    },
    {
      id: 'generation' as const,
      label: 'Generation',
      href: `${baseVideoPath}/generation`,
      status: generationStatus,
      // Locked until user approves remix (generation_status starts 'pending' — locked visually)
      locked: remixStatus !== 'complete' || generationStatus === 'pending',
    },
  ];

  return (
    <div
      className="flex items-center gap-1 border-b mb-6"
      style={{ borderColor: 'var(--re-border-default)' }}
    >
      {tabs.map((tab) => {
        const isActive = tab.id === activeTab;
        const isComplete = tab.status === 'complete';
        const isProcessing = tab.status === 'processing';

        const content = (
          <div
            className={`
              flex items-center gap-2 px-4 py-3 text-sm font-medium transition-colors border-b-2 -mb-px
              ${isActive
                ? 'border-[--re-accent-primary] text-[--re-text-primary]'
                : tab.locked
                  ? 'border-transparent text-[--re-text-muted] cursor-not-allowed'
                  : 'border-transparent text-[--re-text-secondary] hover:text-[--re-text-primary] hover:border-[--re-border-hover]'
              }
            `}
          >
            {isComplete && !isActive && (
              <CheckCircle2 className="w-3.5 h-3.5" style={{ color: 'var(--re-success)' }} />
            )}
            {isProcessing && (
              <Loader2 className="w-3.5 h-3.5 animate-spin" style={{ color: 'var(--re-accent-primary)' }} />
            )}
            {tab.locked && !isComplete && !isProcessing && (
              <Lock className="w-3 h-3" />
            )}
            {tab.label}
          </div>
        );

        if (tab.locked) return <div key={tab.id}>{content}</div>;
        return <Link key={tab.id} href={tab.href}>{content}</Link>;
      })}
    </div>
  );
}
```

**Create `src/components/remix/StartRemixButton.tsx`** (client component)

Calls all 3 remix endpoints in parallel. Shows loading state during the request. On success, navigates to the remix review tab. Enabled only when scrape is complete and remix is not already processing/complete:

```tsx
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Wand2, Loader2 } from 'lucide-react';
import { Button } from '@/components/ui/button';

interface StartRemixButtonProps {
  videoId: string;
  projectId: string;
  scrapeStatus: 'pending' | 'processing' | 'complete' | 'error';
  remixStatus: 'pending' | 'processing' | 'complete' | 'error';
}

export function StartRemixButton({ videoId, projectId, scrapeStatus, remixStatus }: StartRemixButtonProps) {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const router = useRouter();

  // If remix is already done, show "Re-remix" variant
  const isRemixed = remixStatus === 'complete';
  const isDisabled = scrapeStatus !== 'complete' || loading || remixStatus === 'processing';

  async function startRemix() {
    setLoading(true);
    setError(null);

    try {
      // Queue all 3 remix types in parallel — non-fatal if one fails
      await Promise.allSettled([
        fetch('/api/remix-engine/remix/title', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ videoId, projectId }),
        }),
        fetch('/api/remix-engine/remix/thumbnail', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ videoId, projectId }),
        }),
        fetch('/api/remix-engine/remix/script', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ videoId, projectId }),
        }),
      ]);

      // Navigate to remix review page regardless of individual failures
      // The review page will show what completed and what didn't
      router.push(`/dashboard/projects/${projectId}/videos/${videoId}/remix`);
    } catch {
      setError('Failed to start remix. Please try again.');
      setLoading(false);
    }
  }

  return (
    <div className="flex flex-col items-end gap-1">
      <Button
        variant="default"
        size="sm"
        onClick={startRemix}
        disabled={isDisabled}
      >
        {loading ? (
          <Loader2 className="w-4 h-4 mr-1 animate-spin" />
        ) : (
          <Wand2 className="w-4 h-4 mr-1" />
        )}
        {loading ? 'Starting...' : isRemixed ? 'Re-remix' : 'Start Remix'}
      </Button>
      {error && (
        <span className="text-xs" style={{ color: 'var(--re-destructive)' }}>{error}</span>
      )}
    </div>
  );
}
```
  </action>
  <verify>
    <automated>npx tsc --noEmit && npm run test -- --testPathPattern='remix' --watchAll=false --passWithNoTests</automated>
  </verify>
  <done>
    - `src/components/remix/PipelineTabs.tsx` exports PipelineTabs with correct tab states (active, locked, complete, processing)
    - `src/components/remix/StartRemixButton.tsx` exports StartRemixButton, calls all 3 remix endpoints in parallel, navigates to remix route on success
    - TypeScript compiles clean
    - Existing remix tests (Plans 01-03 scope) remain GREEN after component additions
  </done>
</task>

<task type="auto">
  <name>Task 2: Update video detail page and create remix review page shell</name>
  <files>
    src/app/(dashboard)/projects/[id]/videos/[videoId]/page.tsx
    src/app/(dashboard)/projects/[id]/videos/[videoId]/remix/page.tsx
  </files>
  <action>
**Step 1: Update `src/app/(dashboard)/projects/[id]/videos/[videoId]/page.tsx`**

Make targeted modifications to the existing file:
1. Import `PipelineTabs` and `StartRemixButton`
2. Replace the disabled `<Button>` Start Remix with `<StartRemixButton>` (passing video status props)
3. Add `<PipelineTabs>` above the VideoDetailLayout with activeTab="scraping"

The page already fetches `video.*` including `remix_status` and `generation_status`. Use those for the tab state props.

The import additions:
```typescript
import { PipelineTabs } from '@/components/remix/PipelineTabs';
import { StartRemixButton } from '@/components/remix/StartRemixButton';
```

Replace the disabled button (currently around line 139-143):
```tsx
// BEFORE:
<Button variant="default" size="sm" disabled>
  <Wand2 className="w-4 h-4 mr-1" />
  Start Remix
</Button>

// AFTER:
<StartRemixButton
  videoId={videoId}
  projectId={projectId}
  scrapeStatus={video.scrape_status}
  remixStatus={video.remix_status}
/>
```

Add PipelineTabs between the title row and VideoDetailLayout (after the closing `</div>` of the flex row):
```tsx
<PipelineTabs
  projectId={projectId}
  videoId={videoId}
  scrapeStatus={video.scrape_status}
  remixStatus={video.remix_status}
  generationStatus={video.generation_status}
  activeTab="scraping"
/>
```

Remove the `Wand2` import if it's no longer used after removing the disabled button (or keep it if used elsewhere).

**Step 2: Create `src/app/(dashboard)/projects/[id]/videos/[videoId]/remix/page.tsx`**

Server component that fetches all remix data. Shows counts to confirm data is present. The full interactive UI is built in Plan 05's `RemixReviewPage` client component — this page just fetches and passes props:

```tsx
// src/app/(dashboard)/projects/[id]/videos/[videoId]/remix/page.tsx
import { redirect, notFound } from 'next/navigation';
import { createClient } from '@/lib/supabase/server';
import { supabaseAdmin } from '@/lib/supabase/admin';
import { PipelineTabs } from '@/components/remix/PipelineTabs';
import { ChevronLeft, Loader2 } from 'lucide-react';
import Link from 'next/link';

export default async function RemixReviewPage({
  params,
}: {
  params: Promise<{ id: string; videoId: string }>;
}) {
  const { id: projectId, videoId } = await params;

  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect('/login');

  // Fetch video
  const { data: video } = await supabase
    .from('re_videos')
    .select('id, original_title, remix_status, generation_status, scrape_status')
    .eq('id', videoId)
    .eq('project_id', projectId)
    .single();
  if (!video) notFound();

  // Fetch remix data using admin client (bypasses RLS for cross-table reads)
  const [titlesResult, thumbnailsResult, scriptsResult] = await Promise.all([
    supabaseAdmin.from('re_remixed_titles').select('id, style, title, reasoning, is_selected').eq('video_id', videoId).order('created_at'),
    supabaseAdmin.from('re_remixed_thumbnails').select('id, prompt, file_path, is_selected').eq('video_id', videoId).order('created_at'),
    supabaseAdmin.from('re_remixed_scripts').select(`
      id, full_script, tone, total_duration_seconds, is_selected,
      re_scenes ( id, scene_number, dialogue_line, duration_seconds, broll_description, on_screen_text )
    `).eq('video_id', videoId).order('created_at'),
  ]);

  const titles = titlesResult.data ?? [];
  const thumbnails = thumbnailsResult.data ?? [];
  const scripts = scriptsResult.data ?? [];
  const scenes = scripts[0]?.re_scenes ?? [];

  // Generate signed URLs for thumbnails (1-hour expiry, storage stays private)
  const thumbnailsWithUrls = await Promise.all(
    thumbnails.map(async (thumb) => {
      const { data } = await supabaseAdmin.storage
        .from('remix-engine')
        .createSignedUrl(thumb.file_path, 3600);
      return { ...thumb, signedUrl: data?.signedUrl ?? null };
    })
  );

  const isRemixProcessing = video.remix_status === 'processing';
  const isRemixPending = video.remix_status === 'pending';

  return (
    <div>
      {/* Back link */}
      <Link
        href={`/dashboard/projects/${projectId}/videos/${videoId}`}
        className="inline-flex items-center gap-1 text-sm hover:text-[--re-text-primary] transition-colors mb-4"
        style={{ color: 'var(--re-text-muted)' }}
      >
        <ChevronLeft className="w-4 h-4" />
        Back to video
      </Link>

      <h1
        className="font-semibold leading-snug mb-1"
        style={{ fontSize: 'var(--re-text-xl)', color: 'var(--re-text-primary)' }}
      >
        {video.original_title ?? 'Untitled Video'}
      </h1>

      <PipelineTabs
        projectId={projectId}
        videoId={videoId}
        scrapeStatus={video.scrape_status}
        remixStatus={video.remix_status}
        generationStatus={video.generation_status}
        activeTab="remix"
      />

      {/* Processing state */}
      {(isRemixProcessing || isRemixPending) && (
        <div className="flex flex-col items-center justify-center py-24 gap-4">
          <Loader2
            className="w-10 h-10 animate-spin"
            style={{ color: 'var(--re-accent-primary)' }}
          />
          <p style={{ color: 'var(--re-text-secondary)' }}>
            {isRemixPending
              ? 'Remix is queued and will start shortly...'
              : 'Generating remix content... this may take a minute.'}
          </p>
          <p className="text-xs" style={{ color: 'var(--re-text-muted)' }}>
            This page auto-refreshes. You can also leave and come back.
          </p>
        </div>
      )}

      {/* Data loaded state — placeholder until Plan 05 adds RemixReviewPage client component */}
      {video.remix_status === 'complete' && (
        <div className="space-y-4">
          <div
            className="text-sm px-3 py-2 rounded"
            style={{ background: 'var(--re-bg-card)', color: 'var(--re-text-secondary)' }}
          >
            Remix data loaded: {titles.length} titles · {thumbnailsWithUrls.length} thumbnails · {scenes.length} scenes
          </div>
          {/* TODO: RemixReviewPage client component inserted here by Plan 05 */}
        </div>
      )}

      {/* Error state */}
      {video.remix_status === 'error' && (
        <div
          className="text-sm px-4 py-3 rounded"
          style={{ background: 'var(--re-bg-card)', color: 'var(--re-destructive)', border: '1px solid var(--re-destructive)' }}
        >
          Remix failed. Check the job log or try starting remix again from the video page.
        </div>
      )}
    </div>
  );
}
```
  </action>
  <verify>
    <automated>npx tsc --noEmit && npm run test -- --testPathPattern='remix' --watchAll=false --passWithNoTests</automated>
  </verify>
  <done>
    - Video detail page imports and uses PipelineTabs (activeTab="scraping") and StartRemixButton
    - StartRemixButton replaces the previously disabled Start Remix button
    - `src/app/(dashboard)/projects/[id]/videos/[videoId]/remix/page.tsx` exists and fetches titles, thumbnails, and scripts+scenes
    - Remix page shows processing spinner when remix_status is pending/processing, data summary when complete, error message when error
    - TypeScript compiles clean
    - No regressions in existing remix tests
  </done>
</task>

</tasks>

<verification>
```bash
npx tsc --noEmit
npm run lint
npm run build
npm run test -- --testPathPattern='remix' --watchAll=false --passWithNoTests
```
All must pass. The build confirms the new routes compile correctly.
</verification>

<success_criteria>
- Video detail page renders PipelineTabs with correct active/locked states based on video status
- Start Remix button is enabled when scrape_status === 'complete' and calls all 3 remix APIs
- Remix review page route exists and renders based on remix_status (processing, complete, error)
- No hardcoded hex colors anywhere — all `var(--re-*)` tokens
- `npm run build` succeeds
- No regressions in remix test suite
</success_criteria>

<output>
After completion, create `.planning/phases/03-remix-pipeline-4-hours/03-04-SUMMARY.md`
</output>
