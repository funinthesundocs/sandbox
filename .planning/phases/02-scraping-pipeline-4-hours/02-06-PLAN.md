---
phase: 02-scraping-pipeline-4-hours
plan: 06
type: execute
wave: 3
depends_on:
  - "02-03"
  - "02-04"
files_modified:
  - src/components/scraper/ChannelBrowser.tsx
  - src/components/scraper/ChannelVideoGrid.tsx
  - src/components/scraper/BatchQueueList.tsx
  - src/app/(dashboard)/projects/[id]/channel/page.tsx
autonomous: true
requirements:
  - R2.6
  - R2.7
  - R2.9

must_haves:
  truths:
    - "ChannelBrowser accepts a channel URL, resolves it, and shows a browsable grid of channel videos"
    - "Grid/list view toggle works — switches between card grid and compact list"
    - "50 videos per page with Load More button (uses nextPageToken from /api/remix-engine/channel)"
    - "Checkbox selection on each video — max 10 selected enforced with warning"
    - "BatchQueueList shows all selected+enqueued videos with individual status badges: queued, downloading, done, failed"
    - "Overall completion progress bar at top of queue list"
    - "Batch controls: cancel individual job, retry failed job"
    - "Batch scrape dispatched via POST /api/remix-engine/scrape/batch"
    - "All colors use --re-* CSS variables — glassmorphism CSS-only"
  artifacts:
    - path: "src/components/scraper/ChannelBrowser.tsx"
      provides: "Channel URL input → video grid with checkboxes → scrape selected"
      exports: ["ChannelBrowser"]
    - path: "src/components/scraper/ChannelVideoGrid.tsx"
      provides: "Grid/list toggle view of channel videos with checkbox selection"
      exports: ["ChannelVideoGrid"]
    - path: "src/components/scraper/BatchQueueList.tsx"
      provides: "Queue list showing batch scrape progress per video"
      exports: ["BatchQueueList"]
    - path: "src/app/(dashboard)/projects/[id]/channel/page.tsx"
      provides: "Channel batch scrape page at /dashboard/projects/[id]/channel"
  key_links:
    - from: "src/components/scraper/ChannelBrowser.tsx"
      to: "src/app/api/remix-engine/channel/route.ts"
      via: "GET /api/remix-engine/channel?channelUrl=... to fetch channel videos"
      pattern: "api/remix-engine/channel"
    - from: "src/components/scraper/ChannelBrowser.tsx"
      to: "src/app/api/remix-engine/scrape/batch/route.ts"
      via: "POST /api/remix-engine/scrape/batch with selected video URLs"
      pattern: "scrape/batch"
    - from: "src/app/(dashboard)/projects/[id]/channel/page.tsx"
      to: "src/components/scraper/ChannelBrowser.tsx"
      via: "ChannelBrowser receives projectId prop"
      pattern: "ChannelBrowser"
---

<objective>
Build the batch channel scraping UI — the browse-and-pick flow where users paste a channel URL, browse thumbnails, select videos, and queue them for scraping. This plan covers ChannelBrowser, ChannelVideoGrid (with grid/list toggle + checkboxes), BatchQueueList (live progress), and the channel page.

Purpose: Batch scraping is a core Phase 2 requirement (R2.6). Plan 03 built the backend. This plan builds the UI that drives it.
Output: Four components/pages for the complete channel browse and batch scrape experience.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-scraping-pipeline-4-hours/02-CONTEXT.md
@design-system/MASTER.md

LOCKED DECISIONS (from CONTEXT.md — implement EXACTLY):
- Browse-and-pick: paste channel URL → see browsable grid → checkbox-select → scrape
- Grid/list view toggle for browsing channel videos
- 50 videos per page with "Load More" pagination
- Max 10 videos per batch scrape — enforce with warning
- Queue list UI: all selected videos shown with individual status badges (queued, downloading, done, failed)
- Overall completion bar at top of queue
- Batch controls: cancel, retry failed individually

VISUAL DESIGN:
- Glassmorphism on cards (CSS-only — zero extra DOM elements)
- Channel video card: thumbnail + title + duration + checkbox — similar to YouTube's own grid
- Selected state: accent primary border + subtle glow
- Status badges: use STATUS_CONFIG pattern from VideoCard (queued/processing/complete/error)

CLAUDE'S DISCRETION:
- Loading skeleton for channel video grid
- Grid vs list card sizing
- Sort order of queue list (newest first)
- Retry button placement in failed state
</context>

<tasks>

<task type="auto">
  <name>Task 1: ChannelVideoGrid and BatchQueueList</name>
  <files>
    src/components/scraper/ChannelVideoGrid.tsx
    src/components/scraper/BatchQueueList.tsx
  </files>
  <action>
**src/components/scraper/ChannelVideoGrid.tsx** — 'use client'. Grid/list view of channel videos with checkbox selection.

Props:
```typescript
interface ChannelVideoItem {
  youtubeId: string;
  title: string;
  thumbnailUrl: string;
  publishedAt: string;
  channelName: string;
  durationSeconds: number | null;  // null from search.list
}

interface ChannelVideoGridProps {
  videos: ChannelVideoItem[];
  selected: Set<string>;           // Set of youtubeIds
  onToggle: (youtubeId: string) => void;
  viewMode: 'grid' | 'list';
  isLoading?: boolean;
}
```

**Grid mode card** (similar to YouTube's browse grid — thumbnail first):
```jsx
<div
  onClick={() => onToggle(video.youtubeId)}
  className={`relative cursor-pointer rounded-[--re-border-radius] overflow-hidden transition-all duration-150
    bg-[--re-bg-secondary]/60 backdrop-blur-md
    ${isSelected
      ? 'border-2 border-[--re-accent-primary] shadow-[0_0_16px_hsl(217_91%_60%/0.25)]'
      : 'border border-[--re-border]/60 hover:border-[--re-accent-primary]/40 hover:shadow-[0_0_12px_hsl(217_91%_60%/0.12)]'
    }`
  }
>
  {/* Checkbox overlay — top-left */}
  <div className="absolute top-2 left-2 z-10">
    <div className={`w-5 h-5 rounded flex items-center justify-center transition-all
      ${isSelected ? 'bg-[--re-accent-primary] border-[--re-accent-primary]' : 'bg-black/50 border border-white/30'}
    `}>
      {isSelected && <Check className="w-3 h-3 text-white" />}
    </div>
  </div>
  {/* Thumbnail */}
  <div className="aspect-video overflow-hidden">
    <img src={video.thumbnailUrl} alt={video.title} className="w-full h-full object-cover" />
  </div>
  {/* Card body */}
  <div className="p-2.5">
    <p className="text-[--re-text-primary] text-sm font-medium line-clamp-2 leading-snug">{video.title}</p>
    <p className="text-[--re-text-muted] text-xs mt-1">
      {new Date(video.publishedAt).toLocaleDateString()}
    </p>
  </div>
</div>
```

**List mode row** (compact, checkbox on left):
```jsx
<div
  onClick={() => onToggle(video.youtubeId)}
  className={`flex items-center gap-3 p-3 rounded-[--re-border-radius] cursor-pointer transition-all
    ${isSelected ? 'bg-[--re-accent-primary]/10 border border-[--re-accent-primary]/40' : 'bg-[--re-bg-secondary]/60 border border-[--re-border]/60 hover:bg-[--re-bg-hover]'}
  `}
>
  <div className={`w-5 h-5 rounded flex-shrink-0 flex items-center justify-center ${isSelected ? 'bg-[--re-accent-primary]' : 'border border-[--re-border]'}`}>
    {isSelected && <Check className="w-3 h-3 text-white" />}
  </div>
  <img src={video.thumbnailUrl} alt="" className="w-20 h-11 object-cover rounded flex-shrink-0" />
  <div className="flex-1 min-w-0">
    <p className="text-[--re-text-primary] text-sm font-medium truncate">{video.title}</p>
    <p className="text-[--re-text-muted] text-xs mt-0.5">{video.channelName} • {new Date(video.publishedAt).toLocaleDateString()}</p>
  </div>
</div>
```

Grid layout: `grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3`
List layout: `flex flex-col gap-2`

Loading skeleton: 10 placeholder cards with animate-pulse.

**src/components/scraper/BatchQueueList.tsx** — 'use client'. Shows batch scrape queue with per-video progress.

Props:
```typescript
interface QueueItem {
  jobId: string;
  videoId: string;
  youtubeId: string;
  title: string;
  thumbnailUrl: string;
  status: 'queued' | 'processing' | 'complete' | 'error' | 'cancelled';
  progress: number;
  errorMessage?: string | null;
}

interface BatchQueueListProps {
  items: QueueItem[];
  onRetry?: (item: QueueItem) => void;
  onCancelJob?: (jobId: string) => void;
}
```

Compute overall progress: `Math.round(items.reduce((acc, item) => acc + (item.status === 'complete' ? 100 : item.status === 'error' ? 0 : item.progress), 0) / (items.length * 100) * 100)`

UI structure:
```jsx
<div className="space-y-3">
  {/* Overall progress bar */}
  <div className="bg-[--re-bg-secondary] rounded-[--re-border-radius] p-4">
    <div className="flex justify-between text-sm mb-2">
      <span className="text-[--re-text-primary] font-medium">
        {completedCount}/{items.length} videos scraped
      </span>
      <span className="text-[--re-text-muted]">{overallProgress}%</span>
    </div>
    <div className="h-2 bg-[--re-bg-hover] rounded-full overflow-hidden">
      <div
        className="h-full bg-[--re-accent-primary] rounded-full transition-all duration-300"
        style={{ width: `${overallProgress}%` }}
      />
    </div>
  </div>

  {/* Per-video queue rows */}
  {items.map(item => (
    <div key={item.jobId} className="flex items-center gap-3 p-3 rounded-[--re-border-radius] bg-[--re-bg-secondary]/60 backdrop-blur-md border border-[--re-border]/60">
      <img src={item.thumbnailUrl} alt="" className="w-16 h-9 object-cover rounded flex-shrink-0" />
      <div className="flex-1 min-w-0">
        <p className="text-[--re-text-primary] text-sm truncate">{item.title || item.youtubeId}</p>
        {/* Progress bar for processing items */}
        {item.status === 'processing' && (
          <div className="h-1 bg-[--re-bg-hover] rounded-full mt-1.5 overflow-hidden">
            <div className="h-full bg-[--re-accent-primary] rounded-full transition-all duration-500" style={{ width: `${item.progress}%` }} />
          </div>
        )}
        {item.status === 'error' && (
          <p className="text-[--re-destructive] text-xs mt-1 truncate">{item.errorMessage || 'Scrape failed'}</p>
        )}
      </div>
      {/* Status badge */}
      <span className={`text-xs px-2 py-0.5 rounded-full font-medium flex-shrink-0 ${STATUS_BADGE_CLASSES[item.status]}`}>
        {STATUS_LABELS[item.status]}
      </span>
      {/* Actions */}
      <div className="flex gap-1">
        {item.status === 'error' && onRetry && (
          <Button variant="ghost" size="icon" className="w-7 h-7" onClick={() => onRetry(item)} title="Retry">
            <RotateCcw className="w-3.5 h-3.5" />
          </Button>
        )}
        {(item.status === 'queued' || item.status === 'processing') && onCancelJob && (
          <Button variant="ghost" size="icon" className="w-7 h-7 text-[--re-text-muted]" onClick={() => onCancelJob(item.jobId)} title="Cancel">
            <X className="w-3.5 h-3.5" />
          </Button>
        )}
      </div>
    </div>
  ))}
</div>
```

Local STATUS_BADGE_CLASSES and STATUS_LABELS maps:
```typescript
const STATUS_BADGE_CLASSES = {
  queued: 'text-[--re-text-muted] bg-[--re-bg-hover]',
  processing: 'text-[--re-accent-primary] bg-[--re-accent-primary]/10',
  complete: 'text-[--re-success] bg-[--re-success]/10',
  error: 'text-[--re-destructive] bg-[--re-destructive]/10',
  cancelled: 'text-[--re-text-disabled] bg-[--re-bg-hover]',
};
const STATUS_LABELS = {
  queued: 'Queued', processing: 'Scraping', complete: 'Done', error: 'Failed', cancelled: 'Cancelled',
};
```

Import Check, RotateCcw, X from lucide-react. Import Button from '@/components/ui/button'.
  </action>
  <verify>
    <automated>cd /c/Antigravity/Sandbox && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>
    TypeScript compiles cleanly. ChannelVideoGrid shows checkbox on each card, selected state with accent border. List/grid view toggle works via viewMode prop. BatchQueueList shows overall progress bar and per-video rows with status badges and retry/cancel buttons.
  </done>
</task>

<task type="auto">
  <name>Task 2: ChannelBrowser and channel page</name>
  <files>
    src/components/scraper/ChannelBrowser.tsx
    src/app/(dashboard)/projects/[id]/channel/page.tsx
  </files>
  <action>
**src/components/scraper/ChannelBrowser.tsx** — 'use client'. Full channel browse flow.

Props:
```typescript
interface ChannelBrowserProps {
  projectId: string;
}
```

State:
- `channelUrl: string` — input value
- `isLoadingChannel: boolean` — fetching channel videos
- `channelVideos: ChannelVideo[]` — accumulated videos (grows with "Load More")
- `nextPageToken: string | null` — for pagination
- `totalResults: number`
- `channelId: string | null` — resolved channel ID
- `selected: Set<string>` — selected youtubeIds
- `viewMode: 'grid' | 'list'`
- `isBatchScraping: boolean`
- `queueItems: QueueItem[]` — after batch scrape started
- `error: string | null`

Import ChannelVideo from '@/lib/youtube-api/channel'.
Import QueueItem from '@/components/scraper/BatchQueueList' (or define locally — just inline the type).

**handleChannelFetch()**:
1. setIsLoadingChannel(true); setError(null); setChannelVideos([]); setSelected(new Set())
2. GET /api/remix-engine/channel?channelUrl={encodeURIComponent(channelUrl)}
3. On success: setChannelVideos(data.items); setNextPageToken(data.nextPageToken); setTotalResults(data.totalResults); setChannelId(data.channelId)
4. On error: setError(data.error || 'Could not load channel videos')
5. setIsLoadingChannel(false)

**handleLoadMore()**:
1. GET /api/remix-engine/channel?channelUrl={channelUrl}&pageToken={nextPageToken}
2. setChannelVideos(prev => [...prev, ...data.items]); setNextPageToken(data.nextPageToken)

**handleToggleVideo(youtubeId)**:
```typescript
setSelected(prev => {
  const next = new Set(prev);
  if (next.has(youtubeId)) {
    next.delete(youtubeId);
  } else {
    if (next.size >= 10) {
      setError('Maximum 10 videos per batch scrape');
      return prev;
    }
    next.add(youtubeId);
  }
  return next;
});
```

**handleBatchScrape()**:
1. const selectedVideos = channelVideos.filter(v => selected.has(v.youtubeId))
2. const youtubeUrls = selectedVideos.map(v => `https://www.youtube.com/watch?v=${v.youtubeId}`)
3. setIsBatchScraping(true)
4. POST /api/remix-engine/scrape/batch with { youtubeUrls, projectId }
5. Map response.enqueued to QueueItem[] (status: 'queued', progress: 0, title from selectedVideos lookup, thumbnailUrl from selectedVideos lookup)
6. Also map response.duplicates to QueueItem[] (status: 'complete', progress: 100, show as "Already exists")
7. setQueueItems([...enqueued, ...duplicates])
8. setIsBatchScraping(false)

**handleRetry(item)**:
1. POST /api/remix-engine/scrape with { youtubeUrl: `https://youtube.com/watch?v=${item.youtubeId}`, projectId }
2. Update queueItems: set status back to 'queued' for that item

**UI structure:**
```jsx
<div>
  {/* Channel URL input */}
  {queueItems.length === 0 && (
    <div className="mb-6">
      <form onSubmit={e => { e.preventDefault(); handleChannelFetch(); }}>
        <div className="flex gap-3">
          <input
            type="text"
            value={channelUrl}
            onChange={e => setChannelUrl(e.target.value)}
            placeholder="Paste YouTube channel URL or @handle"
            className="flex-1 h-9 px-3 rounded-[--re-border-radius] bg-[--re-bg-input] border border-[--re-border] text-[--re-text-primary] placeholder:text-[--re-text-muted] outline-none focus:border-[--re-accent-primary] text-sm"
          />
          <Button type="submit" disabled={isLoadingChannel || !channelUrl.trim()} size="sm">
            {isLoadingChannel ? <Loader2 className="w-4 h-4 animate-spin" /> : 'Browse'}
          </Button>
        </div>
      </form>
      {error && <p className="text-[--re-destructive] text-sm mt-2">{error}</p>}
    </div>
  )}

  {/* Queue list (shown after batch scrape starts) */}
  {queueItems.length > 0 && (
    <div className="mb-6">
      <BatchQueueList items={queueItems} onRetry={handleRetry} />
      <Button variant="ghost" size="sm" className="mt-3" onClick={() => { setQueueItems([]); setSelected(new Set()); }}>
        Browse more videos
      </Button>
    </div>
  )}

  {/* Channel video grid */}
  {channelVideos.length > 0 && queueItems.length === 0 && (
    <div>
      {/* Header: results count + view toggle + selection count + scrape button */}
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-3">
          <span className="text-[--re-text-muted] text-sm">{totalResults} videos</span>
          {selected.size > 0 && (
            <span className="text-[--re-accent-primary] text-sm font-medium">{selected.size} selected</span>
          )}
        </div>
        <div className="flex items-center gap-2">
          {/* View toggle */}
          <Button
            variant="ghost" size="icon"
            onClick={() => setViewMode(v => v === 'grid' ? 'list' : 'grid')}
            className="w-8 h-8"
          >
            {viewMode === 'grid' ? <List className="w-4 h-4" /> : <LayoutGrid className="w-4 h-4" />}
          </Button>
          {/* Scrape selected */}
          <Button
            size="sm"
            disabled={selected.size === 0 || isBatchScraping}
            onClick={handleBatchScrape}
          >
            {isBatchScraping ? <Loader2 className="w-4 h-4 animate-spin mr-2" /> : null}
            Scrape {selected.size > 0 ? `${selected.size} Video${selected.size > 1 ? 's' : ''}` : 'Selected'}
          </Button>
        </div>
      </div>

      <ChannelVideoGrid
        videos={channelVideos}
        selected={selected}
        onToggle={handleToggleVideo}
        viewMode={viewMode}
      />

      {/* Load More */}
      {nextPageToken && (
        <div className="flex justify-center mt-6">
          <Button variant="outline" size="sm" onClick={handleLoadMore}>
            Load More
          </Button>
        </div>
      )}
    </div>
  )}
</div>
```

Import Loader2, List, LayoutGrid from lucide-react. Import Button from '@/components/ui/button'. Import ChannelVideoGrid from './ChannelVideoGrid'. Import BatchQueueList from './BatchQueueList'.

**src/app/(dashboard)/projects/[id]/channel/page.tsx** — Server component. Simple wrapper page.

```typescript
import { redirect } from 'next/navigation';
import { notFound } from 'next/navigation';
import Link from 'next/link';
import { ChevronLeft } from 'lucide-react';
import { createClient } from '@/lib/supabase/server';
import { ChannelBrowser } from '@/components/scraper/ChannelBrowser';

export default async function ChannelScrapePage({ params }: { params: Promise<{ id: string }> }) {
  const { id: projectId } = await params;
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect('/login');

  const { data: project } = await supabase
    .from('re_projects')
    .select('id, name')
    .eq('id', projectId)
    .single();
  if (!project) notFound();

  return (
    <div>
      <Link href={`/dashboard/projects/${projectId}`} className="text-[--re-text-muted] text-sm hover:text-[--re-text-primary] flex items-center gap-1 mb-4">
        <ChevronLeft className="w-4 h-4" /> Back to {project.name}
      </Link>
      <div className="mb-6">
        <h1 className="text-xl font-semibold text-[--re-text-primary]">Scrape from Channel</h1>
        <p className="text-[--re-text-muted] text-sm mt-1">Browse a YouTube channel and select up to 10 videos to scrape.</p>
      </div>
      <ChannelBrowser projectId={projectId} />
    </div>
  );
}
```

Also, add a "Scrape from Channel" button to the project detail page (src/app/(dashboard)/projects/[id]/page.tsx) — a Link to /dashboard/projects/{id}/channel — placed next to or below the ScrapeInput.
  </action>
  <verify>
    <automated>cd /c/Antigravity/Sandbox && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>
    TypeScript compiles cleanly. ChannelBrowser shows URL input, fetches channel videos, allows checkbox selection up to 10, dispatches batch scrape, and shows BatchQueueList after. Grid/list view toggle works. Load More pagination works. Channel page at /dashboard/projects/[id]/channel renders ChannelBrowser.
  </done>
</task>

</tasks>

<verification>
Run: npx tsc --noEmit — must pass with zero errors.
Check: src/components/scraper/ChannelBrowser.tsx contains "selected.size >= 10" check.
Check: src/components/scraper/ChannelVideoGrid.tsx contains both grid and list view implementations.
Check: src/components/scraper/BatchQueueList.tsx contains overall progress bar calculation.
Check: src/app/(dashboard)/projects/[id]/channel/page.tsx renders ChannelBrowser with projectId.
</verification>

<success_criteria>
- ChannelBrowser fetches channel videos from /api/remix-engine/channel
- Checkbox selection enforces max 10 with user-visible error
- Grid/list view toggle changes layout
- Load More fetches next page using nextPageToken
- Batch scrape sends selected URLs to POST /api/remix-engine/scrape/batch
- BatchQueueList shows overall progress bar + per-video status
- Retry button appears on failed items
- Cancel button appears on queued/processing items
- Channel page accessible at /dashboard/projects/[id]/channel
</success_criteria>

<output>
After completion, create `.planning/phases/02-scraping-pipeline-4-hours/02-06-SUMMARY.md` following the summary template.
</output>
